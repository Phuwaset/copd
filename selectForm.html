<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประเมิน</title>
    <link rel="icon" type="images/x-icon" href="./image/ya.png">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-image: linear-gradient(to right, rgba(12, 123, 178, 0.871), rgba(237, 237, 220, 0.874));
        }

        /* Navbar styling */
        .navbar {
            border-bottom: 1px solid #ddd;
        }

        .navbar-brand {
            font-weight: bold;
        }

        .navbar-nav .nav-item .nav-link {
            padding: 0.5rem 1rem;
        }

        .navbar-nav .nav-item .nav-link.active {
            background-color: #e9ecef;
            border-radius: 0.375rem;
        }

        .d-flex {
            display: flex;
            align-items: center;
        }

        .d-flex p {
            margin: 0;
            color: #495057;
            font-size: 1rem;
            margin-right: 1rem;
            font-weight: 500;
        }

        .d-flex .btn-outline-danger {
            margin-left: 1rem;
        }

        .dropdown-menu {
            min-width: 200px;
        }
    </style>
</head>

<body>

    <center>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a href="#"><img class="logo_nav img-fluid" src="./image/siemsee.gif" width="30px" height="30px"
                        alt="Logo"></a>
                <a class="navbar-brand" style="font-size: 15px; margin-left: 10px;">โรคปอดอุดกั้นเรื้อรัง</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">

                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="selectForm.html">ลงทะเบียน</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">คําแนะนําการปฏิบัติตัว</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                เกี่ยวกับเรา
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="member.html">ประวัติจัดทำ</a></li>
                                <li><a class="dropdown-item" href="#">ผู้พัฒนา Application</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="d-flex align-items-center ms-auto">
                        <p id="name">ชื่อ: </p>
                        <p id="surname">นามสกุล: </p>
                        <a href="logout.html" class="btn btn-outline-danger ms-3">ออกจากระบบ</a>
                    </div>
                </div>
            </div>
        </nav>

        <br>
    </center>
    <div class="container">
        <div class="row"></div>
        <br>
        <div class="row text-center p-1">
            <div class="col-sm-6" style="margin-bottom: 10px;">
                <div class="card">
                    <div class="card-body">
                        <br>
                        <h5 class="card-title"><b style="color: rgb(0, 177, 177);">ประเมิน mMRC / CAT</b></h5>
                        <hr>
                        <div class="container">
                            <img src="./image/logo_copd.jpg" class="img-fluid" alt="COPD Image" width="53%" height="60%" style="border-radius: 5px;">
                        </div>
                        <hr>
                        <a href="./testAndQmMRC/1Qmmrc.html" class="btn btn-outline-info"  id="submitLink" onclick="goToMMRC()">กรอกข้อมูล</a>
                    </div>
                </div>
            </div>

            <div class="col-sm-6" style="margin-bottom: 10px;">
                <div class="card">
                    <div class="card-body">
                        <br>
                        <!-- <hr> -->
                        <h5 class="card-title"><b style="color: rgb(0, 177, 177);">เก็บรวบรวมข้อมูล</b></h5>
                        <hr>
                        <!-- <br> -->
                        <div class="container">
                            <img src="./image/sum_data.jpg" class="img-fluid" alt="QR Code Image" width="50%" height="60%" style="border-radius: 5px;">
                        </div>
                        <hr class="">
                        <a href="./smoke/smokeIndex.html" class="btn btn-outline-info" id="submitLink1" onclick="goToSmoke()">กรอกข้อมูล</a>
                    </div>
                </div>
            </div>

            <div class="col-sm-6" style="margin-bottom: 10px;">
                <div class="card">
                    <div class="card-body">
                        <hr>
                        <h5 class="card-title"><b style="color: rgb(0, 177, 177);">คำแนะนำ</b></h5>
                        <hr>
                        <div class="container">
                            <img src="./image/copd.jpg" class="img-fluid" style="border-radius: 10px;"
                                alt="Evaluation Image" width="45%" height="50%">
                        </div>
                        <hr>
                        <a href="./recommand/index_recommand.html" id="submitLink2" class="btn btn-outline-info">กรอกข้อมูล</a>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="card">
                    <div class="card-body">
                        <hr>
                        <h5 class="card-title"><b style="color: rgb(0, 177, 177);">การประเมินผล</b></h5>
                        <hr>
                        <div class="container">
                        <img src="./image/data_copd.jpg" class="img-fluid" style="border-radius: 10px;"
                                alt="Logo Data Image" width="47%" height="50%">
                        </div>
                        <hr>
                        <a href="./check/check.html" id="submitLink3" class="btn btn-outline-info">กรอกข้อมูล</a>
                    </div>
                </div>
            </div>
        </div>

        <br><br>
    </div>

    <br><br>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Extract URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            // const Id_P = urlParams.get('Id_P');
            const name = urlParams.get('name');
            const surname = urlParams.get('surname');

            // Retrieve Id_P and name from localStorage
            // const storedId_P = localStorage.getItem('userId_P');
            const storedName = localStorage.getItem('userName');
            const storedSurname = localStorage.getItem('surname')


            // สร้าง URL พร้อมพารามิเตอร์
            const url = `./testAndQmMRC/1Qmmrc.html?name=${encodeURIComponent(name)}&surname=${encodeURIComponent(surname)}`;
            const url_smoke = `./smoke/smokeIndex.html?name=${encodeURIComponent(name)}&surname=${encodeURIComponent(surname)}`;
            const url_recomand = `./recommand/index_recommand.html?name=${encodeURIComponent(name)}&surname=${encodeURIComponent(surname)}`;
            const url_check = `./check/check.html?name=${encodeURIComponent(name)}&surname=${encodeURIComponent(surname)}`;
            
            // เปลี่ยน href ของลิงก์ให้ไปยัง URL ที่สร้างขึ้น
            document.getElementById('submitLink').setAttribute('href', url);
            document.getElementById('submitLink1').setAttribute('href', url_smoke);
            document.getElementById('submitLink2').setAttribute('href', url_recomand);
            document.getElementById('submitLink3').setAttribute('href', url_check);

            // // ตรวจสอบว่ามี session ใน localStorage หรือไม่ หากไม่มีให้บังคับกลับไปหน้า login
            if (!name && !surname) {
                window.location.href = 'index.html';
                return; // หยุดการทำงานถัดไปเพื่อป้องกันการเกิดข้อผิดพลาด
            }


            // ถ้ามีข้อมูล Id_P และ name จาก URL, เก็บลง localStorage
            if (name && username) {
                // localStorage.setItem('userId_P', Id_P);
                localStorage.setItem('userName', name);
                localStorage.setItem('surname', surname);
                // console.log('ID_P:', Id_P);
                console.log('Name:', name);
                console.log('surname', surname);
            }

            // เลือกใช้ Id_P จาก URL ถ้ามี หรือจาก localStorage
            const finalId_P = name || surname;

            // Fetch ข้อมูลจาก API โดยใช้ Id_P
            if (finalId_P) {
                fetch(`https://script.google.com/macros/s/AKfycbyhEK82Je5EoAGXkbD-9w2GxkZbx24TAucJ8fWrXpYn45DMU-q-rp_QSqzePWSbfG1ptg/exec?Id_P=${encodeURIComponent(finalId_P)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // console.log('Fetched Data:', data);
                        document.getElementById('name').textContent = `ชื่อ: ${data.name || 'N/A'}`;
                        document.getElementById('surname').textContent = `นามสกุล: ${data.surname || 'N/A'}`;
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            } else {
                console.error('No valid ID_P found.');
                window.location.href = 'index.html'; // Redirect if there's no valid ID_P
            }

            // ป้องกันการย้อนกลับโดยใช้ history.pushState
            window.history.pushState(null, "", window.location.href);
            window.onpopstate = function () {
                // ป้องกันการกดปุ่มย้อนกลับ
                Swal.fire({
                    title: 'คำเตือน!',
                    text: 'ไม่สามารถย้อนกลับได้ กรุณาออกจากระบบก่อน',
                    icon: 'warning',
                    confirmButtonText: 'ตกลง'
                }).then(() => {
                    window.history.pushState(null, "", window.location.href); // บังคับให้อยู่ในหน้าเดิม
                });
            };
        });
    </script>



</body>

</html>
